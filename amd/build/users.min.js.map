{"version":3,"file":"users.min.js","sources":["../src/users.js"],"sourcesContent":["define([\n    \"jquery\",\n    \"local_datatables/repository\",\n    \"local_datatables/datatables/dataTables.helper\",\n    \"core_form/modalform\",\n    \"core/toast\",\n    \"core/str\",\n    \"core/notification\",\n    \"local_datatables/datatables/dataTables.dateTime\",\n    \"local_datatables/datatables/moment\",\n    \"local_datatables/datatables/jquery.dataTables\",\n    \"local_datatables/datatables/dataTables.bootstrap4\",\n    \"local_datatables/datatables/dataTables.responsive\",\n    \"local_datatables/datatables/responsive.bootstrap4\",\n    \"local_datatables/datatables/dataTables.buttons\",\n    \"local_datatables/datatables/buttons.bootstrap4\",\n    \"local_datatables/datatables/buttons.colVis\",\n    \"local_datatables/datatables/buttons.html5\",\n    \"local_datatables/datatables/buttons.print\",\n    \"local_datatables/bootstrap-select/bootstrap-select\",\n], function($,\n    Repository,\n    Helper,\n    ModalForm,\n    Toast,\n    Str,\n    Notification,\n    DateTime,\n    moment,\n    ) {\n    /**\n     * Factory function that generates a modal form based on the provided parameters.\n     *\n     * @param {DataTable} table - The DataTable instance associated with the modal form.\n     * @param {string} formClass - The class name for the form.\n     * @param {string} titleKey - The key for the modal title string.\n     * @param {string} successKey - The key for the success message string.\n     * @returns {Function} - A function that creates and shows a modal when invoked.\n     */\n    function createModalForm(table, formClass, titleKey, successKey) {\n        return function(event) {\n            var title = Str.get_strings([{key: titleKey, component: 'local_registration'}]);\n            var id = $(this).attr('data-id');\n            var langString = Str.get_strings([{key: successKey, component: 'local_registration'}]);\n\n            var modal = new ModalForm({\n                formClass: 'local_registration\\\\form\\\\' + formClass + '_form',\n                args: {id: id},\n                modalConfig: {title: title},\n                returnFocus: event.currentTarget,\n                saveButtonText: Str.get_string('save')\n            });\n            modal.show();\n            modal.addEventListener(modal.events.FORM_SUBMITTED, () => {\n                table.draw();\n                Toast.add(langString, {\n                    autohide: true,\n                    closeButton: true,\n                    type: 'success',\n                });\n            });\n        };\n    }\n\n    var init = function() {\n        $(document).ready(function() {\n            var tableid = '#users';\n            var orderColumn = 1; // Set the default ordering column index\n\n            var table = $(tableid).DataTable({\n                initComplete: function() {\n                    // Add key type events with 1 second of delay for searching\n                    var typingTimer;\n                    var doneTypingInterval = 500; // 0.5 second\n\n                    $(tableid + \" .filters\").on(\"keyup\", \"input\", function() {\n                        // Clear the existing timer if it exists\n                        clearTimeout(typingTimer);\n\n                        // Start a new timer\n                        typingTimer = setTimeout(function() {\n                            table.column($(this).data(\"index\")).search(this.value).draw();\n                        }.bind(this), doneTypingInterval);\n                    });\n\n                    // Event for handling when the user stops typing\n                    $(tableid + \" .filters\").on(\"keydown\", \"input\", function() {\n                        // Clear the existing timer if it exists\n                        clearTimeout(typingTimer);\n                    });\n\n                    // Trigger search on select lists\n                    $(tableid + \" .filters\").on(\"change\", \"select\", function() {\n                        // Apply the filter for selected values\n                        var selectedValues = $(this).val();\n\n                        if (Array.isArray(selectedValues) && selectedValues.length > 1) {\n                            table.column($(this).data(\"index\")).search(selectedValues.join('|'), true, false).draw();\n                        } else {\n                            table.column($(this).data(\"index\")).search(selectedValues).draw();\n                        }\n                    });\n\n                    // Init datetime fields\n                    const datetimeElements = document.querySelectorAll('.datetime');\n\n                    if (datetimeElements) {\n                        datetimeElements.forEach(function(element) {\n                            const index = element.getAttribute('data-index');\n                            DateTime.use(moment);\n                            new DateTime(element, {\n                                format: 'DD/MM/YY',\n                                buttons: {\n                                    clear: true\n                                },\n                                onChange: function(value, date, input) {\n                                    table.column(index).search(value).draw();\n                                }\n                            });\n                        });\n                    }\n\n                    // Show the datatable.\n                    $(tableid).removeClass('hidden');\n\n                    Helper.initResponsiveTable(table);\n                },\n                processing: true,\n                serverSide: true,\n                ajax: function(data, callback) {\n                    // Execute the asynchronous operation\n                    const promise = Repository.process({\n                        'data': JSON.stringify(data),\n                        'namespace': 'local_registration',\n                        'tableid': 'users',\n                    })\n                    .then(json => {\n                        const parsedData = JSON.parse(json);\n                        return parsedData; // Return the parsed data\n                    })\n                    .catch(error => {\n                        Notification.exception(error);\n                        throw error; // Re-throw the error to propagate it further\n                    });\n\n                    // After the Promise resolves successfully, call the callback function\n                    promise.then(parsedData => {\n                        return callback(parsedData); // Call the callback function with the parsed data\n                    });\n\n                    return promise; // Return the original Promise\n                },\n                searchDelay: 400,\n                orderCellsTop: true,\n                fixedHeader: true,\n                responsive: {\n                    details: {\n                        type: 'column',\n                        target: 0,\n                    }\n                },\n                paging: true,\n                order: [[orderColumn, \"asc\"]],\n                lengthChange: true,\n                lengthMenu: [\n                    [10, 20, 30, -1],\n                    [10, 20, 30, \"All\"],\n                ],\n                columns: [\n                    // Data: data to display,\n                    // name: Raw data column name.\n                    // orderable: column name for ordering.\n                    // searchable: column name for searching.\n                    {defaultContent: ''},\n                    {data: \"firstname\", name: \"firstname\"},\n                    {data: \"lastname\", name: \"lastname\"},\n                    {\n                        data: \"email\", name: \"email\",\n                        render: function(data, type, row) {\n                            if (row.notified == 1) {\n                                return row.email + '<br><span class=\"badge bg-warning\">' +\n                                    M.util.get_string(\"notified\", \"local_registration\") + '</span>';\n                            } else {\n                                return row.email;\n                            }\n                        }\n                    },\n                    {data: \"tenantname\", name: \"t.id\", orderable: \"t.name\", searchable: \"equals||t.name\"},\n                    {\n                        data: \"country_formatted\", name: \"country\",\n                        orderable: \"country_text\", searchable: \"equals||country_text\"},\n                    {data: \"gender\", name: \"gender\", searchable: \"equals\"},\n                    {data: \"domain\", name: \"domain\", searchable: \"equals\"},\n                    {data: \"comments\", name: \"comments\"},\n                    {data: \"interests_formatted\", name: \"interests\"},\n                    {\n                        data: \"confirmed_formatted\", name: \"confirmed\",\n                        orderable: \"confirmed_text\", searchable: \"equals||confirmed_text\"\n                    },\n                    {data: \"timecreated_formatted\", name: \"lr.timecreated\", searchable: \"datetime\"},\n                    {\n                        data: {},\n                        render: function(data) {\n                            var btnApprove = '<button class=\"btn btn-success btn-sm btn-approve\" ' +\n                            'data-action=\"approve\" data-id=\"' + data.id + '\">' +\n                                M.util.get_string('approve', 'local_registration') + '</button>';\n\n                            var btnReject = '<button class=\"btn btn-danger btn-sm btn-reject\" ' +\n                            'data-action=\"reject\" data-id=\"' + data.id + '\">' +\n                                M.util.get_string('reject', 'local_registration') + '</button>';\n\n                            var btnNotify = '';\n                            if (data.notified !== 1) {\n                                btnNotify = '<button class=\"btn btn-warning btn-sm btn-notify\" ' +\n                            'data-action=\"notify\" data-id=\"' + data.id + '\">' +\n                                M.util.get_string('notify', 'local_registration') + '</button>';\n                            }\n\n                            return '<span class=\"buttons\" data-value=\"' + data.id + '\">' +\n                                btnApprove + btnReject + btnNotify + ' </span>';\n                        },\n                        name: \"actions\",\n                        orderable: false,\n                        searchable: false\n                    },\n                ],\n                columnDefs: [\n                    {\n                        targets: 0,\n                        className: 'dtr-control noVis',\n                        orderable: false,\n                        searchable: false\n                    },\n                ],\n                dom: '<B<l><t>ftrip>',\n                buttons: [\n                    {\n                        extend: 'collection',\n                        className: 'exportButton',\n                        text: 'Export',\n                        buttons: [\n                            {\n                                extend: 'copy',\n                                exportOptions: {\n                                    columns: ':visible:not(.noVis)',\n                                }\n                            },\n                            {\n                                extend: 'print',\n                                exportOptions: {\n                                    columns: ':visible:not(.noVis)',\n                                }\n                            },\n                            {\n                                extend: 'excel',\n                                exportOptions: {\n                                    columns: ':visible:not(.noVis)',\n                                }\n                            },\n                            {\n                                extend: 'csv',\n                                exportOptions: {\n                                    columns: ':visible:not(.noVis)',\n                                }\n                            },\n                        ]\n                    },\n                    {\n                        extend: 'colvis',\n                        columns: ':not(.noVis)'\n                    }\n                ]\n            });\n\n            // Create modal forms on buttons click\n            table.on('click', '.btn-approve',\n                createModalForm(table, 'approve', 'modal:approvetitle', 'modal:approvesuccess'));\n\n            table.on('click', '.btn-reject',\n                createModalForm(table, 'reject', 'modal:rejecttitle', 'modal:rejectsuccess'));\n\n            table.on('click', '.btn-notify',\n                createModalForm(table, 'notify', 'modal:notifytitle', 'modal:notifysuccess'));\n\n            // Reset filters\n            table.on('click', '.reset-filters', function() {\n                Helper.resetTableFilters(table, false);\n            });\n        });\n    };\n    return {\n        init: init,\n    };\n});\n"],"names":["define","$","Repository","Helper","ModalForm","Toast","Str","Notification","DateTime","moment","createModalForm","table","formClass","titleKey","successKey","event","title","get_strings","key","component","id","this","attr","langString","modal","args","modalConfig","returnFocus","currentTarget","saveButtonText","get_string","show","addEventListener","events","FORM_SUBMITTED","draw","add","autohide","closeButton","type","init","document","ready","DataTable","initComplete","typingTimer","tableid","on","clearTimeout","setTimeout","column","data","search","value","bind","selectedValues","val","Array","isArray","length","join","datetimeElements","querySelectorAll","forEach","element","index","getAttribute","use","format","buttons","clear","onChange","date","input","removeClass","initResponsiveTable","processing","serverSide","ajax","callback","promise","process","JSON","stringify","then","json","parse","catch","error","exception","parsedData","searchDelay","orderCellsTop","fixedHeader","responsive","details","target","paging","order","lengthChange","lengthMenu","columns","defaultContent","name","render","row","notified","email","M","util","orderable","searchable","btnApprove","btnReject","btnNotify","columnDefs","targets","className","dom","extend","text","exportOptions","resetTableFilters"],"mappings":"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"}